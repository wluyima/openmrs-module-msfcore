<htmlform
	formUuid="aab2cab6-c280-438b-9afd-3c54e799ef2a"
	formName="Prescribe Medication"
	formEncounterType="fa6f3ff5-b784-43fb-ab35-a08ab7dbf074"
	formVersion="1.1" formAddMetadata="no">
	<!-- Autogenerated example form  (template from 01-Nov-2010 -->
	<macros>
		paperFormId = (Fill this in)
		headerColor =#009d8e
		fontOnHeaderColor = white
	</macros>

	<script type="text/javascript">
		var NUMBER_ENTRIES = 10;
		
        if (jQuery) {
            jq(document).ready(function () {

                <ifMode mode="VIEW">
                        jq('button.no-print').hide();
                </ifMode>
				 	
				<!-- handle operation buttons -->
				jq(".msf-operation-button").on("click", function() {
					jq("#msf-operation").attr("value", this.value);
					return true;
				});

                // enabling and disabling the allergy sections there are only 5 so far
                if( jq(getUsedContainers()).length == 1){
                    jq('#1-removeEntry').remove();
                 }
                jq('#1-toggleContainer').show();
                jq('#' + NUMBER_ENTRIES + '-addEntry').remove();


                // show and remove sections
                jq('button.addEntry').on("click", function(){
                    var correctedAddButtonId = parseFloat(this.id) + 1;
                    var contentAddId = "#" + correctedAddButtonId + "-toggleContainer";
                    jq(contentAddId).toggle(true);
                    //jq('#' + this.id).toggle(false);
                    //jq('#' + parseFloat(this.id) + '-removeEntry').toggle(false);
                    return false;
                });

                jq('button.removeEntry').on("click", function () {
                    var correctedRemoveButtonId = parseFloat(this.id) - 1;
                    var contentAddId = "#" + parseFloat(this.id) + "-toggleContainer";
                    jq(contentAddId).toggle(false);
                    jq(':input:not(:button)', contentAddId).val([]);
                    jq('#' + correctedRemoveButtonId + '-addEntry').toggle(true);
                    jq('#' + correctedRemoveButtonId + '-removeEntry').toggle(true);
                    return false;
                });

                // show any prescriptions that have been saved
                for (i = 1; i &lt; NUMBER_ENTRIES; i++) {
                    if (getValue('name-' + i + '.value') != false) {
                        //jq('#' + i + '-addEntry').toggle(false);
                        jq('#' + i + '-toggleContainer').show();
                    }
                }
                
                beforeSubmit.push(function() {
					var duplicatedIds = getDulpicatedMedicationIds()
					
					if(duplicatedIds.length > 0){
						
						var errorMessage = '<lookup expression="fn.message('msfcore.ncdbaseline.prescribemedication.error.duplicationprescription')"/> : '

						duplicatedIds.forEach(function(medicationId){
							errorMessage += $("select[id^=w] option[value='" + medicationId + "']").first().text() + ','
						});

						jq('#duplication-prescription-error').html(errorMessage)
						jq('#duplication-prescription-error').show()
                		return false;
                	}
                	return true;
				});

				beforeSubmit.push(function() {
					var requiredMessage = '<lookup expression="fn.message('msfcore.required')"/>';
					return validateRequiredFields(getRequiredFieldIds(), requiredMessage);
				});

            });

			function getIndexFromId(id) {
				return parseInt(id.split('-')[0]);
			}

			function getRequiredFieldIds() {
				var requiredFieldIds = [];
				getUsedContainers().forEach(function(container) {
					var index = getIndexFromId(container.attr('id'));
					requiredFieldIds.push(`name-${index}`);
					requiredFieldIds.push(`dose${index}`);
					requiredFieldIds.push(`doseUnit${index}`);
					requiredFieldIds.push(`frequencyCoded${index}`);
					requiredFieldIds.push(`duration${index}`);
					requiredFieldIds.push(`durationUnit${index}`);
				});
				return requiredFieldIds;
			}

            function getUsedContainers() {
                var usedContainers = [];
                for (var i = 1; i &lt;= NUMBER_ENTRIES; i++) {
                    var containerId = `${i}-toggleContainer`;
                    if (i == 1 || isPrescriptionFilled(i) || jq(`#${i}-toggleContainer`).is(':visible')) {
                        usedContainers.push(jq(`#${i}-toggleContainer`));
                    }
                }
                return usedContainers;
            }
            
            function isPrescriptionFilled(i) {
                var filled;
                if (typeof(getValue) != 'undefined') {
                    filled = getValue(`name-${i}.value`) != "";
                } else {
                    filled = jq(`#name-${i}`).children('.value').length > 0;
                }
                return filled;
            }
                       
            function getPrescribedMedicationIds(){
           		return getUsedContainers()
           			    .map((container) => getValue(`name-${getIndexFromId(container.attr('id'))}.value`))
           			    .filter((r) => r !== "");
            }
           
            function getDulpicatedMedicationIds() {
		    	var object = {};
		        var result = [];
		
		        getPrescribedMedicationIds().forEach(function (item) {
		          if(!object[item])
		              object[item] = 0;
		            object[item] += 1;
		        })
		        for (var prop in object) {
		           if(object[prop] >= 2) {
		               result.push(prop);
		           }
		        }
		        return result;
		    }
        }
	</script>

	<div class="wrapper">
		<uiInclude provider="msfcore" fragment="baselineLeftMenu"/>
		<div class="right-form-display">
			<div style="display:none;">
				<section headerLabel="Encounter Details">
					<table class="baseline-aligned">
						<tr>
							<td>Date:</td>
							<td>
								<encounterDate default="now" disallowMultipleEncountersOnDate="block" showTime="true" />
							</td>
						</tr>
						<tr>
							<td>Location:</td>
							<td>
								<encounterLocation default="SessionAttribute:emrContext.sessionLocationId"/>
							</td>
						</tr>
						<tr>
							<td>Provider:</td>
							<td>
								<encounterProvider default="currentUser"/>
							</td>
						</tr>
					</table>
				</section>
			</div>

			<div class="sections-container">
				<section id="drug-orders">
                    <h3>7. <lookup expression="fn.message('msfcore.ncdbaseline.prescribemedication.title')"/></h3>
					<div class="note-container">
						<div id="duplication-prescription-error" class="note error" style="display: none;"></div>
					</div>
					<repeat>
						<template>
							<div id="{prescription}-toggleContainer" style="display: none;">
								<obsgroup groupingConceptId="f1af211e-64e0-46e6-bc9d-e848935e2202"> 
									<div class="input-group">
										<h4><lookup expression="fn.message('msfcore.ncdbaseline.prescribemedication.name')"/></h4>
										<obs id="name-{prescription}" class="medication-name" conceptId="17110937-6cb2-42f9-b932-3f79e9506a1d"/>
									</div>
									<div class="input-group">
										<h4><lookup expression="fn.message('msfcore.ncdbaseline.prescribemedication.dose')"/></h4>
										<obs id="dose{prescription}" class="doseInput" conceptId="160856"/>
										<obs id="doseUnit{prescription}" answerConceptSetIds="d09764da-2bf1-4ab6-933f-07a50add8f33" 
											conceptId="d09764da-2bf1-4ab6-933f-07a50add8f33" class="doseInput select-arrow"  />
									</div>
									<div class="input-group">
										<h4><lookup expression="fn.message('msfcore.ncdbaseline.prescribemedication.frequency')"/></h4>
										<obs id="frequencyCoded{prescription}" class="frequency select-arrow" conceptId="160855" />
									</div>
									<div class="input-group">
										<h4><lookup expression="fn.message('msfcore.ncdbaseline.prescribemedication.duration')"/></h4>
										<obs id="duration{prescription}" class="duration doseInput" conceptId="159368"/>
									</div>
									<div class="input-group">
										<h4><lookup expression="fn.message('msfcore.ncdbaseline.prescribemedication.amount')"/></h4>
										<obs id="durationUnit{prescription}" answerConceptSetIds="161244AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" 
											conceptId="161244AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" class="duration-unit select-arrow" />
									</div>
									<div class="input-group">
										<h4><lookup expression="fn.message('msfcore.ncdbaseline.prescribemedication.administrativeinstructions')"/></h4>
										<obs id="instructions{prescription}" class="medication-instructions" conceptId="163106" style="textarea" rows="3" cols="80"/>
									</div>
									<div class="hide-on-view">
										<button class="addEntry" id="{prescription}-addEntry"><lookup expression="fn.message('msfcore.ncdbaseline.addanother')"/>
										</button>
										<button class="removeEntry" id="{prescription}-removeEntry"><lookup expression="fn.message('msfcore.ncdbaseline.remove')"/></button>
									</div>
								</obsgroup>
							</div>
						</template>
						<render prescription="1"/>
						<render prescription="2"/>
						<render prescription="3"/>
						<render prescription="4"/>
						<render prescription="5"/>
						<render prescription="6"/>
						<render prescription="7"/>
						<render prescription="8"/>
						<render prescription="9"/>
						<render prescription="10"/>
					</repeat>

		            <!-- Submit -->
					<div class="bottom-of-form">
						<button class="msf-operation-button no-print" value="ncd.baseline.prescribemedication.previous"><lookup expression="fn.message('msfcore.previous')"/></button>
						<button class="primary right msf-operation-button no-print" value="ncd.baseline.prescribemedication.next"><lookup expression="fn.message('msfcore.next')"/></button>
					</div>
				</section>
			</div>
		</div>
	</div>

	<postSubmissionAction class="org.openmrs.module.msfcore.formaction.handler.HtmlFormPostSubmissionAction" />
</htmlform>
